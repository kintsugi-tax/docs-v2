name: Update API Documentation

on:
  # Run every 6 hours to catch API changes
  schedule:
    - cron: '0 */6 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
  
  # Run on relevant code changes
  push:
    branches: [main]
    paths:
      - 'scripts/generate-api-docs.sh'
      - 'scripts/add-mcp-config.sh'
      - 'scripts/add-mcp-config-to-endpoints.sh'
      - 'scripts/create-merged-openapi.py'

jobs:
  update-api-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install Mintlify scraper
        run: npm install -g @mintlify/scraping
      
      - name: Download OpenAPI specs
        run: |
          echo "üì• Downloading OpenAPI specifications..."
          
          # Download Customer API spec
          echo "üì• Fetching Customer API spec..."
          curl -o openapi-customer.json https://api-doc.trykintsugi.com/openapi.json
          
          # Download Partners API spec  
          echo "üì• Fetching Partners API spec..."
          curl -o openapi-partners.json https://api.trykintsugi.com/openapi.json
          
          echo "‚úÖ OpenAPI specs downloaded successfully!"
      
      - name: Create merged OpenAPI file
        run: |
          echo "üîß Creating merged OpenAPI file (Customer API + Public Partners API)..."
          
          # Copy Customer API to openapi.json temporarily (script expects it)
          cp openapi-customer.json openapi.json
          
          # Make script executable
          chmod +x scripts/create-merged-openapi.py
          
          # Run script to create merged file
          python3 scripts/create-merged-openapi.py
          
          echo "‚úÖ Merged OpenAPI file created!"
          echo "  - Contains Customer API endpoints"
          echo "  - Contains Public Partners API endpoints (from 'API Reference - Partners')"
          echo "  - All endpoints have MCP enabled"
      
      - name: Validate OpenAPI spec
        run: |
          echo "üîç Validating merged OpenAPI specification..."
          
          # Check if merged file exists and is not empty
          if [ ! -s openapi.json ]; then
            echo "‚ùå Merged OpenAPI spec is empty or missing"
            exit 1
          fi
          
          # Verify MCP configuration
          echo "üîç Verifying MCP configuration..."
          jq -e '."x-mint".mcp.enabled == true' openapi.json > /dev/null && echo "‚úÖ Merged OpenAPI has MCP enabled" || echo "‚ùå Merged OpenAPI missing MCP config"
          
          # Count paths
          path_count=$(jq '.paths | length' openapi.json)
          echo "‚úÖ Merged OpenAPI spec contains $path_count paths"
          
          echo "‚úÖ OpenAPI spec is valid!"
      
      - name: Generate API documentation
        run: |
          echo "üöÄ Generating API documentation from merged OpenAPI spec..."
          mkdir -p reference/api reference/partners
          
          echo "üì• Generating API reference documentation..."
          npx @mintlify/scraping openapi-file openapi.json -o reference/api
          
          echo "‚úÖ API documentation generated successfully!"
      
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet && git diff --cached --quiet && [ -z "$(git ls-files --others --exclude-standard)" ]; then
            echo "No changes to commit"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push changes
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Add all changes (source OpenAPI files + merged OpenAPI file + generated docs)
          git add openapi-customer.json openapi-partners.json openapi.json reference/api/
          git commit -m "ü§ñ Auto-update API documentation and OpenAPI spec [skip ci]

          - Updated merged openapi.json (Customer API + Public Partners API endpoints)
          - Source: Customer API from https://api-doc.trykintsugi.com/openapi.json
          - Source: Public Partners API endpoints from 'API Reference - Partners' section
          - All endpoints have MCP enabled for single /mcp server
          - Regenerated API reference documentation
          - Generated on: $(date)"
          git push
          
          echo "‚úÖ API documentation and OpenAPI spec updated and committed"
      
      - name: No changes message
        if: steps.changes.outputs.changed == 'false'
        run: echo "‚ÑπÔ∏è No changes to API documentation"
